<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>编辑简历</title>
    <link rel="stylesheet" href="css/iview.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/css.css">
    <link rel="stylesheet" href="css/job.css">
    <link rel="stylesheet" href="css/swiper.min.css">

    <script src="js/jquery-1.9.1.js"></script>
    <script src="js/js.js"></script>
    <script src="js/imgsize.js"></script>
    <script src="js/swiper.min.js"></script>
    <script src="js/vue.min.js"></script>
    <script src="js/axios.min.js"></script>
    <script src="js/axios.config.js"></script>
    <script src="js/iview.js"></script>
    <script src="js/bootstrap.min.js"></script>


    <script type="text/javascript">
        function mainPage(){
            $(".page").hide();
            $("#main_page").show()
        }
        function skillEdit(){
            $(".page").hide();
            $("#skill_edit").show()
        }
    </script>
</head>

<body>
<div class="page" id="app">
    <!--<div class="header">-->
        <!--&lt;!&ndash; <a href="javascript:mainPage()" class="btn_back">返回</a> &ndash;&gt;-->
        <!--<a href="javascript:history.go(-1)" class="btn_back">返回</a>-->
        <!--<h1 class="title">编辑简历</h1>-->
    <!--</div>-->


    <!--<div class="content" style="padding: .79rem 0 .96rem 0;" >-->

    <!--<div class="content" style="padding: 0 0 .96rem 0;" >-->
        <!--<div class="order_headname">教育经历</div>-->
        <!--<div>-->
            <!--<ul class="ttip_mod">-->
                <!--<li class="item" v-for="(list,index) in patchData.edu_exp" :key="index">-->

                    <!--<ul style="display: block"  >-->
                        <!--<li><p>{{ list.name }}<a href="" @click.prevent="delMsg(index)" class="red-del">&nbsp;&nbsp;&nbsp;&nbsp;删除</a></p></li>-->
                        <!--<li><p>{{ list.enrollment_date ? list.enrollment_date : '入学时间' }}&nbsp;&nbsp;至&nbsp;&nbsp;{{ list.graduation_date ? list.graduation_date : '毕业时间' }}</p></li>-->
                        <!--<li><p>{{ list.education }}</p></li>-->
                        <!--<li><p>{{ list.specialty }}</p></li>-->
                    <!--</ul>-->

                <!--</li>-->
            <!--</ul>-->
            <!--&lt;!&ndash;<a href="" class="btn-edu" @click.prevent="popEdu()">+添加教育经历</a>&ndash;&gt;-->
            <!--&lt;!&ndash;<img src="images/ticket_3.png" class="ticket-bg">&ndash;&gt;-->
        <!--</div>-->

    <!--</div>-->

    <div class="order_headname">教育经历</div>
    <div class="order_issure1" style="display: block;" id="show-li-1">
        <ul class="ttip_mod">
            <li class="item li-edu">

                <ul style="display: block" class="ttip_mod" v-for="(edu,index) in patchData.edu_exp" :key="index">
                    <li class="item"><p>{{ edu.name }}<a href="" @click.prevent="delMsg(index)" class="red-del">&nbsp;&nbsp;&nbsp;&nbsp;删除</a></p></li>
                    <li class="item"><p>{{ edu.enrollment_date ? edu.enrollment_date : '入学时间' }}&nbsp;&nbsp;至&nbsp;&nbsp;{{ edu.graduation_date ? edu.graduation_date : '毕业时间' }}</p></li>
                    <li class="item"><p>{{ edu.education }}</p></li>
                    <li class="item"><p>{{ edu.specialty }}</p></li>
                </ul>


            </li>

        </ul>
        <!--<hr>-->

        <!--<ul class="add-edu edu-exp">-->
        <!--<li><input type="text" class="form-control" placeholder="请输入学校名" v-model="addSts.name"></li>-->
        <!--<li class="study-ru">入学时间:&nbsp;&nbsp;&nbsp;&nbsp;<input type="date" v-model="addSts.enrollment_date"></li>-->
        <!--<li class="study-bi">毕业时间:&nbsp;&nbsp;&nbsp;&nbsp;<input type="date" v-model="addSts.graduation_date"></li>-->
        <!--<li><input type="text" class="form-control" placeholder="获得学历" v-model="addSts.education"></li>-->
        <!--<li><input type="text" class="form-control" placeholder="请输入学习专业" v-model="addSts.specialty"></li>-->
        <!--<button type="button" class="btn btn-default btn-lg btn-block" @click.prevent="addNone">添加教育经历</button>-->
        <!--</ul>-->
        <!--<a href="" class="btn-edu" @click.prevent="popEdu()">+添加教育经历</a>-->

        <!--style="margin-top: 1.2rem"-->

        <!--<img src="images/ticket_3.png" class="ticket-bg">-->
    </div>



    <!--<div id="edu-hide">-->
        <!--<ul class="add-edu edu-exp" >-->
            <!--<li class="form-group"><input type="text" id="recipient-name" class="form-control" placeholder="请输入学校名" v-model="addSts.name"></li>-->
            <!--<li class="study-ru form-group">入学时间:&nbsp;&nbsp;&nbsp;&nbsp;<input type="date" id="start-time" v-model="addSts.enrollment_date"></li>-->
            <!--<li class="study-bi form-group">毕业时间:&nbsp;&nbsp;&nbsp;&nbsp;<input type="date" id="graduate-time" v-model="addSts.graduation_date"></li>-->
            <!--<li class="form-group"><input type="text" id="input-education" class="form-control" placeholder="获得学历" v-model="addSts.education"></li>-->
            <!--<li class="form-group"><input type="text" id="input-specialty" class="form-control" placeholder="请输入学习专业" v-model="addSts.specialty"></li>-->
        <!--</ul>-->
        <!--&lt;!&ndash;<button type="button" class="btn btn-default btn-lg btn-block" style="margin-top: 0.6rem;" @click.prevent="addNone">添加教育经历</button>&ndash;&gt;-->
    <!--</div>-->
    <!--<button type="button" class="btn btn-default btn-lg btn-block" style="margin-top: 0.6rem;" @click.prevent="addEdu">添加教育经历</button>-->
    <!---->

    <div>
        <button type="button" class="btn btn-primary btn-lg btn-block" data-toggle="modal" style="margin-bottom: 1.3rem;"
                data-target="#exampleModal" data-whatever="@mdo" @click.prevent="popEdu()">+添加教育经历
        </button>

        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">添加教育经历</h4>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="form-group">
                                <!--<label for="recipient-name" class="control-label">Recipient:</label>-->
                                <input type="text" class="form-control" id="recipient-name" placeholder="请输入学校名"
                                       v-model="addSts.name">
                            </div>
                            <div class="form-group">
                                入学时间:
                                <input type="date" v-model="addSts.enrollment_date" id="start-time">
                            </div>
                            <div class="form-group">
                                毕业时间:
                                <input type="date" v-model="addSts.graduation_date" id="graduate-time">
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="请输入获得学历"
                                       v-model="addSts.education" id="input-education">
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="请输入学习专业"
                                       v-model="addSts.specialty" id="input-specialty">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal" @click.prevent="addNone">
                            确定
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="popu-join-btn">
        <!--<a href="" class="btn-join btn-gray" @click.prevent="updateFunc()">保存</a>-->
        <button type="button" class="btn btn-lg btn-join" @click="updateFunc()" >保存</button>
    </div>


</div>

    <script type="text/javascript">
        var vm = new Vue({
            el: '#app',
            data() {
                return {

                    userInfo: {
                        avatar: 'https://gss0.bdstatic.com/-4o3dSag_xI4khGkpoWK1HF6hhy/baike/c0%3Dbaike92%2C5%2C5%2C92%2C30/sign=62d46c39067b020818c437b303b099b6/d4628535e5dde7119c3d076aabefce1b9c1661ba.jpg'
                    },
                    // addSts: [],
                    addSts:{
                        name:'学校名称',
                        specialty:'专业',
                        enrollment_date:"入学时间",
                        graduation_date:'毕业时间',
                        education:'学历',
                    },
                    addSts2:{
                        name:'会社名称',
                        position:'职位',
                        job_content:'工作内容',
                        join_date:'加入时间',
                        quit_date:'退社时间'
                    },

                    postData:{
                        resume_name : "",// 简历名称
                        name : "",// 姓名
                        phonetic_notation : "",// 日语注音
                        gender : "",// 性别: male男 female女
                        mobile : "",//  电话号码
                        mail : "",//  电子邮箱
                        address : "",//  详细地址
                        motivation : "",//  求职动机
                        professional_skill: "",//  专业技能
                        interests : "",//  兴趣爱好
                        birthday : "",//  生日
                        spouse : "",// 配偶
                        // head_portrait : "",// 头像
                        province : "",// 现住地一级行政区ID
                        city : "",// 现住地下级地区ID
                        metro_name : "",// 最寄駅线路名称
                        metro_station : "",// 最寄駅站点名称
                        census_register : "",// 户籍所在地
                        immigration : "",// 日本在留资格
                        stay_time : "",// 来日年数
                        family_num : "",// 抚养家族数
                        japanese_grade : "",// 日语水平
                        language_ability : "",// 日语能力试验
                        education : "",// 最终学历
                        job_status : "",// 求职状态
                        nature_work: "",// 工作性质
                        edu_exp : [],// 教育经历
                        work_exp : [],// 工作经验
                    },

                    patchData: {
                        edu_exp : [],// 教育经历
                    },

                    resume_name: '', // 	简历名称
                    info_name:'',  // 姓名
                    phonetic_notation: '', // 日语注音
                    mobile: '', // 联系电话
                    mail: '', //电子邮箱
                    head_portrait: '', // 头像
                    address: '', // 详细地址
                    motivation:'',// 求职动机
                    professional_skill:'', //专业技能
                    interests: '', // 兴趣爱好
                    birthday: '', // 生日


                    info: [], // 用来保存所有的信息
                    status: [], // 日本再留资格
                    days: [], //来日年数
                    family: [], // 抚养家族数
                    Japan: [],  // 日语口语水平
                    language: [], // 日语能力试验
                    educational: [], // 最终学历
                    job_status: [],  // 求职状态
                    pay_type: [], //  支付方式
                    welfare : [], //  福利
                    job_category : [], //  工作性质
                    area: [], // 现住所1级
                    area2: [], // 现住所2级
                    metro: [], // 地铁1级
                    metro2: [], // 地铁2级
                    census: [], // 户籍所在地 地址
                    id: '', // 判断id是不是等于1，如果是为正社员简历，2为小时工简历
                    show: true,

                    edu_exp: [], // 保存数据的列表
                    schoolName: '',
                    specialty: '',
                    education: '',
                    enrollment_date: '',
                    graduation_date: '',

                    work_exp: [], // 保存工作经验的列表
                    nameSociety: '', // 入社名称
                    position: '', // 职位
                    job_content: '', // 工作内容
                    join_date: '', // 加入时间
                    quit_date: '', // 退社时间

                }
            },
            created() {
                this.judgeID();
                this.addSts.name = "";
                this.addSts.specialty="";
                this.addSts.education="";
                this.addSts.enrollment_date="";
                this.addSts.graduation_date="";
                this.getUrlId();
                this.getOneResume();

                $("#edu-hide").hide();

                // 添加教育经历弹出框
                $('#exampleModal').on('show.bs.modal', function (event) {
                    var button = $(event.relatedTarget);
                    var recipient = button.data('whatever');
                    var modal = $(this);
                    modal.find('.modal-title').text('New message to ' + recipient);
                    modal.find('.modal-body input').val(recipient)
                });

            },
            methods: {
                getUrlId() {
                    if (getUrlParam('id')==1) {
                        this.postData.nature_work = "EMPLOYEE"
                    }else {
                        this.postData.nature_work = "HOURS_EMPLOYEE"
                    }
                },

                judgeID() {  // 判断id是不是等于1，如果是为正社员简历，2为小时工简历
                    this.id = getUrlParam('id');
                    console.log(this.id);
                    if (this.id == 2) {
                        this.show = !this.show;
                    }
                },

                // 以下是弹出教育经历
                popEdu() {
                    $(".edu-exp").show();
                    this.addSts.name = "";
                    this.addSts.specialty="";
                    this.addSts.education="";
                    this.addSts.enrollment_date="";
                    this.addSts.graduation_date="";
                },
                addEdu() {
                    $("#edu-hide").show();
                },
                addNone() {
                    // let a =  JSON.parse(JSON.stringify(this.addSts));
                    // this.patchData.edu_exp.push(a);
                    // $(".edu-exp").hide(); // 点击添加后，让大盒子隐藏起来
                    var schoolName = $('#recipient-name').val();
                    var startTime = $('#start-time').val();
                    var graduateTime = $('#graduate-time').val();
                    var inputEducation = $('#input-education').val();
                    var inputSpecialty = $('#input-specialty').val();
                    if (schoolName == '' || startTime == '' || graduateTime == '' || inputEducation == '' || inputSpecialty == '') {
                        alert('信息必填');
                        return;
                    }

                    let a =  JSON.parse(JSON.stringify(this.addSts));
                    this.patchData.edu_exp.push(a);
                    // $(".edu-exp").hide(); // 点击添加后，让大盒子隐藏起来
                    $("#exampleModal").hide(); // 点击添加后，让大盒子隐藏起来
                    $("#show-li-1").show(); // 显示模块
                    $("#edu-hide").hide();

                },
                delMsg(index) {
                    // console.log(index);
                    // this.patchData.edu_exp.splice(index, 1); // 删除一条数据
                    // this.popEdu();  // 弹出 填写教育经历

                    console.log(index);
                    this.patchData.edu_exp.splice(index, 1); // 删除一条数据
                    console.log(this.patchData.edu_exp.length);
                    if ( this.patchData.edu_exp.length <= 0 ) {
                        $("#show-li-1").css({"display": "none"}); // 没有数据的时候隐藏模块
                    }
                    $("#edu-hide").show();
                    this.addSts.name = "";
                    this.addSts.specialty="";
                    this.addSts.education="";
                    this.addSts.enrollment_date="";
                    this.addSts.graduation_date="";
                },

                // 图片 头像上传
                // 打开图片上传
                uploadHeadImg() {
                    this.$el.querySelector('.hiddenInput').click()
                },
                handleFile(e) {
                    let $target = e.target || e.srcElement;
                    let file = $target.files[0];
                    var reader = new FileReader();
                    reader.onload = (data) => {
                        let res = data.target || data.srcElement;
                        this.userInfo.avatar = res.result
                    };
                    reader.readAsDataURL(file)
                },

                updateFunc() {
                    if ( this.patchData.edu_exp.length <= 0 ) {
                        return;  // 数据为空的话，保存的按钮不生效
                    }
                    let param = new FormData();
                    param.append("edu_exp", JSON.stringify(this.patchData["edu_exp"]));
                    console.log(param);

                    axios.patch("/resume/" + getUrlParam('id') + "/",param,{
                        headers:{
                            // "Content-Type":"application/x-www-form-urlencoded",
                            // "Content-Type":"application/json",
                            "Content-Type":"multipart/form-data",
                            "Authorization":"JWT " + localStorage.getItem("usertoken")
                        }
                    })
                        .then(res=>{
                            console.log(res.data);
                            alert('更新成功');
                            if (checkWebview() == 'ios') {
                                window.webkit.messageHandlers.goBack.postMessage(null); // 移动端返回上一页

                            }else {
                                window.android.goBack(); // android移动端返回上一页
                            }
                            // setTimeout(() => {
                            //     history.go(-1);
                            // }, 1500)
                        }).catch(error=>{
                            // alert('保存失败，信息必填');
                            console.log(error);
                            // try{
                            //     alert(JSON.stringify(error.response.data))
                            // }catch (e) {
                            //     alert(e)
                            // }
                            for (let d in error.response.data) {
                                alert(error.response.data[d]);
                                break;
                            }
                    })
                }, // 点击保存更新简历

                getOneResume() {
                    this.$axios.get('/resume/'+ getUrlParam('id') +'/',{
                        headers: {
                            'Authorization': "JWT " + localStorage.getItem("usertoken")
                        },
                    })
                        .then(res => {
                            // debugger;
                            console.log(res.data.edu_exp);
                            for (var i = 0; i<res.data.edu_exp.length; i++) {
                                this.addSts.name = res.data.edu_exp[i].name ; // 默认值赋值 学校
                                this.addSts.enrollment_date = res.data.edu_exp[i].enrollment_date ; // 默认值赋值 入学时间
                                this.addSts.graduation_date = res.data.edu_exp[i].graduation_date ; // 默认值赋值 毕业时间
                                this.addSts.education = res.data.edu_exp[i].education ; // 默认值赋值 学历
                                this.addSts.specialty = res.data.edu_exp[i].specialty ; // 默认值赋值 专业
                            }
                            this.patchData.edu_exp = res.data.edu_exp;
                        })
                        .catch(error => {
                            alert('请求单个简历信息失败');
                        })
                },
            },
        });

        //通过正则匹配获取当前页面的url中的参数
        function getUrlParam(name){
            var reg = new RegExp("(^|&)"+name+"=([^&]*)(&|$)");
            var r =  window.location.search.substr(1).match(reg);
            var strValue = "";
            if (r!=null){
                strValue= unescape(r[2]);
            }
            return strValue;
        }
        // 返回 ios还是android
        function checkWebview() {
            var sUserAgent = navigator.userAgent.toLowerCase();
            if (sUserAgent.match(/MicroMessenger/i) == "micromessenger") {
                return "wxweb";
            }
            else {
                var bIsIpad = sUserAgent.match(/ipad/i) == "ipad";
                var bIsIphoneOs = sUserAgent.match(/iphone os/i) == "iphone os";
                var bIsAndroid = sUserAgent.match(/android/i) == "android";
                if (bIsIpad || bIsIphoneOs) {  //ios
                    return "ios";
                } else if (bIsAndroid) {         //android
                    return "android";
                }
            }
            return "web";
        }

    </script>

</body>
</html>
